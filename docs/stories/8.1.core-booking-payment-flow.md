# Story 8.1: The Core Booking & Payment Flow

## Status

Ready for Implementation

## Story

**As a** Customer,
**I want** to complete a comprehensive booking flow with payment processing,
**so that** I can securely book and pay for cleaning services, and businesses can receive confirmed, paid bookings.

## Acceptance Criteria

1. **Enhanced Booking UI**: Multi-step booking form with professional design and progress indicators
2. **Date/Time Selection**: Visual calendar interface with business availability checking
3. **Service Customisation**: Options to customise service details and add special requests
4. **Price Calculation**: Dynamic pricing with breakdown (service + extras + platform fee)
5. **Stripe Integration**: Secure payment processing with card input and validation
6. **Payment Confirmation**: Professional confirmation page with booking details and receipt
7. **Email Notifications**: Automated emails for booking confirmation and payment receipt
8. **Booking Management**: Ability to view, modify, or cancel bookings (with refund policies)
9. **Business Notification**: Real-time notification to business when booking is made
10. **Mobile Responsive**: Seamless experience across all device sizes

## Design Requirements

### **Booking Flow Steps**

1. **Service Selection** (Already complete from Story 3.1)
2. **Date & Time Selection** (Already complete - basic version)
3. **Enhanced Details** (New - service customisation and special requests)
4. **Customer Information** (New - verify contact details and address)
5. **Payment** (New - Stripe card input and processing)
6. **Confirmation** (Enhanced - professional receipt and next steps)

### **Visual Design**

- **Progress Indicator**: Clear step-by-step progress bar at the top
- **Professional Forms**: Clean, well-spaced forms with validation
- **Price Breakdown**: Transparent pricing with itemised costs
- **Trust Indicators**: Security badges, SSL indicators, money-back guarantees
- **Loading States**: Professional spinners during payment processing
- **Success Animation**: Celebration animation on successful booking

## Tasks / Subtasks

### **PHASE 1: Enhanced Booking UI**

- [ ] Task 1.1: Multi-step booking flow
  - [ ] Create booking flow container component with step management
  - [ ] Build progress indicator component showing current step
  - [ ] Add smooth transitions between booking steps
  - [ ] Implement form state persistence across steps
  - [ ] Add "Back" and "Next" navigation controls

- [ ] Task 1.2: Enhanced date/time selection
  - [ ] Upgrade existing calendar to show business availability
  - [ ] Add time slot selection with available/unavailable states
  - [ ] Integrate with business schedule and existing bookings
  - [ ] Add buffer time between bookings
  - [ ] Show popular time slots and recommendations

- [ ] Task 1.3: Service customisation
  - [ ] Build service options selector (add-ons, extras)
  - [ ] Create special requests textarea
  - [ ] Add photo upload for specific areas needing attention
  - [ ] Implement recurring booking options
  - [ ] Add property details form (size, rooms, access info)

### **PHASE 2: Stripe Payment Integration**

- [ ] Task 2.1: Stripe setup and configuration
  - [ ] Install Stripe SDK and dependencies
  - [ ] Set up Stripe account and API keys
  - [ ] Configure Stripe Connect for business payouts
  - [ ] Create webhook endpoints for payment events
  - [ ] Set up test mode for development

- [ ] Task 2.2: Payment interface
  - [ ] Integrate Stripe Elements for card input
  - [ ] Build secure payment form component
  - [ ] Add card validation and error handling
  - [ ] Implement saved payment methods
  - [ ] Add platform fee calculation
  - [ ] Create payment summary with price breakdown

- [ ] Task 2.3: Payment processing
  - [ ] Create payment intent on booking initiation
  - [ ] Process payment on booking confirmation
  - [ ] Handle payment success/failure states
  - [ ] Implement payment retry logic
  - [ ] Add refund functionality for cancellations
  - [ ] Store payment records in database

### **PHASE 3: Booking Confirmation & Management**

- [ ] Task 3.1: Confirmation experience
  - [ ] Build professional confirmation page
  - [ ] Add success animation and celebration
  - [ ] Display booking summary and receipt
  - [ ] Show payment confirmation details
  - [ ] Add "Add to Calendar" functionality
  - [ ] Provide next steps and preparation tips

- [ ] Task 3.2: Email notifications
  - [ ] Set up email service (Supabase Email or SendGrid)
  - [ ] Create booking confirmation email template
  - [ ] Create payment receipt email template
  - [ ] Send emails to customer and business
  - [ ] Add reminder emails before appointment
  - [ ] Create cancellation email template

- [ ] Task 3.3: Booking management
  - [ ] Create booking details page
  - [ ] Add modify booking functionality
  - [ ] Implement cancellation flow with refund
  - [ ] Show booking status and updates
  - [ ] Add customer-business messaging
  - [ ] Create booking history view

### **PHASE 4: Business Integration**

- [ ] Task 4.1: Business notifications
  - [ ] Send real-time notification when booking is made
  - [ ] Update business dashboard with new booking
  - [ ] Show booking details and customer info
  - [ ] Add quick accept/decline actions
  - [ ] Integrate with business calendar

- [ ] Task 4.2: Payment distribution
  - [ ] Set up Stripe Connect for businesses
  - [ ] Configure automatic payouts after service completion
  - [ ] Calculate platform fee and business earnings
  - [ ] Create earnings dashboard for businesses
  - [ ] Add payout history and financial reports

### **PHASE 5: Edge Cases & Polish**

- [ ] Task 5.1: Error handling
  - [ ] Handle payment decline gracefully
  - [ ] Manage booking conflicts and double-bookings
  - [ ] Handle network failures during payment
  - [ ] Add timeout handling for long processes
  - [ ] Create user-friendly error messages

- [ ] Task 5.2: Testing & optimisation
  - [ ] Test payment flow with Stripe test cards
  - [ ] Test all booking scenarios (success, failure, cancellation)
  - [ ] Test webhook handling and retries
  - [ ] Performance testing for payment processing
  - [ ] Security audit of payment flow
  - [ ] Cross-browser and device testing

## Technical Implementation

### **Stripe Architecture**

```
Customer                    Cleanly Platform              Business
   |                              |                           |
   |-- Select Service ----------->|                           |
   |-- Choose Date/Time --------->|                           |
   |-- Enter Payment Info ------->|                           |
   |                              |                           |
   |<-- Create Payment Intent ----|                           |
   |                              |                           |
   |-- Confirm Payment ---------->|                           |
   |                              |-- Process Payment ------->| Stripe
   |                              |<-- Payment Success -------|
   |                              |                           |
   |<-- Booking Confirmed --------|-- Notify Business ------->|
   |                              |                           |
   |                              |-- Hold Funds ------------>| Stripe
   |                              |                           |
   |                   [Service Completed]                    |
   |                              |                           |
   |                              |-- Release Payout -------->| Stripe
   |                              |                           |<-- Business Paid
```

### **Database Schema Updates**

**Payments Table**:

```prisma
model Payment {
  id                String   @id @default(cuid())
  bookingId         String   @unique
  booking           Booking  @relation(fields: [bookingId], references: [id])

  stripePaymentId   String   @unique
  amount            Int      // Amount in pence
  platformFee       Int      // Platform commission
  businessAmount    Int      // Amount paid to business

  status            PaymentStatus // PENDING, SUCCEEDED, FAILED, REFUNDED
  currency          String   @default("GBP")

  refundAmount      Int?
  refundReason      String?
  refundedAt        DateTime?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

enum PaymentStatus {
  PENDING
  PROCESSING
  SUCCEEDED
  FAILED
  REFUNDED
  PARTIALLY_REFUNDED
}
```

**Booking Updates**:

```prisma
model Booking {
  // ... existing fields

  payment           Payment?
  totalAmount       Int      // Total price in pence
  serviceFee        Int      // Service base price
  extras            Json?    // Additional services/fees
  platformFee       Int      // Cleanly commission

  specialRequests   String?
  propertyDetails   Json?    // Size, rooms, access info
  photos            String[] // URLs to uploaded photos

  cancellationReason String?
  cancelledBy       String?  // CUSTOMER or BUSINESS

  stripePaymentIntentId String?
}
```

### **API Endpoints (tRPC)**

- `booking.calculatePrice(serviceId, extras, date)` - Get total price with breakdown
- `booking.createPaymentIntent(bookingDetails)` - Initiate Stripe payment
- `booking.confirmBooking(paymentIntentId, bookingId)` - Complete booking after payment
- `booking.cancel(bookingId, reason)` - Cancel booking with refund
- `booking.modify(bookingId, updates)` - Modify booking details
- `payment.processRefund(bookingId, amount)` - Process refund
- `business.connectStripe(businessId)` - Connect business Stripe account
- `business.getEarnings(businessId, dateRange)` - Get business earnings

### **Stripe Integration Points**

1. **Payment Intent Creation**: When customer reaches payment step
2. **Payment Confirmation**: When customer submits payment
3. **Webhook Handling**: `payment_intent.succeeded`, `payment_intent.failed`, `charge.refunded`
4. **Connect Onboarding**: When business completes profile
5. **Transfer Creation**: After service completion
6. **Payout**: Automatic transfer to business bank account

### **Pricing Structure**

- **Service Base Price**: Set by business
- **Add-ons/Extras**: Additional services or products
- **Platform Fee**: 15% commission on total service price
- **Payment Processing**: Stripe fee (~2.5% + 20p)
- **Customer Pays**: Service + Extras + Platform Fee
- **Business Receives**: Service + Extras - Platform Fee - Stripe Fee

### **Security Considerations**

- **PCI Compliance**: Use Stripe Elements (no card data touches our servers)
- **HTTPS Only**: All payment pages must be HTTPS
- **Payment Intent**: Use payment intents for secure payment flow
- **Webhook Verification**: Verify Stripe webhook signatures
- **Idempotency**: Use idempotency keys to prevent duplicate charges
- **Rate Limiting**: Limit payment attempts to prevent abuse

## Success Metrics

- **Booking Completion Rate**: >70% of started bookings completed with payment
- **Payment Success Rate**: >95% of payment attempts successful
- **Average Booking Time**: <5 minutes from service selection to confirmation
- **Payment Processing Time**: <3 seconds for payment confirmation
- **Refund Processing**: <24 hours for refund to appear
- **Customer Satisfaction**: >4.5 stars for booking experience

## Testing Strategy

### **Payment Testing**

Use Stripe test cards:

- `4242 4242 4242 4242` - Success
- `4000 0000 0000 9995` - Decline
- `4000 0000 0000 3220` - 3D Secure authentication

### **Test Scenarios**

1. âœ… Successful booking with payment
2. âœ… Payment declined - retry flow
3. âœ… Booking cancellation with full refund
4. âœ… Booking modification (date/time change)
5. âœ… Network failure during payment
6. âœ… Double-booking prevention
7. âœ… Webhook handling and retries
8. âœ… Business payout after completion
9. âœ… Platform fee calculation
10. âœ… Refund processing

## Dependencies

- **Stripe Account**: Platform Stripe account with Connect
- **Email Service**: Transactional email provider
- **File Storage**: For photo uploads (Supabase Storage)
- **Calendar Integration**: Optional - Google Calendar, iCal
- **SMS Service**: Optional - Twilio for SMS notifications

## User Stories Covered

- âœ… FR4: Booking request flow with acceptance
- âœ… FR6: Stripe payment integration after acceptance
- âœ… FR7: Dashboard view of bookings
- âœ… Enhanced booking experience with payment

## Next Steps After Completion

- **Story 9**: Update dashboards with live booking data and real-time updates
- **Enhanced Analytics**: Track booking conversion, revenue, and platform metrics
- **Customer Reviews**: Add review system after service completion
- **Loyalty Programme**: Rewards for repeat customers

---

**Ready to implement the complete end-to-end booking and payment flow! ðŸ’³ðŸš€**
